# name: test/sql/monaco_routing.test
# description: test travel_time extension with Monaco routing data
# group: [sql]

require travel_time

require spatial

# Load Monaco tiles
statement ok
SELECT travel_time_load_config('./valhalla_data/valhalla.json');

# Test: Config loaded successfully
query I
SELECT travel_time_is_loaded();
----
true

# Test: Simple route between two Monaco points (Casino to Palace)
# Casino: 7.4281, 43.7396
# Palace: 7.4197, 43.7312
query I
SELECT travel_time_route_wkb('POINT(7.4281 43.7396)', 'POINT(7.4197 43.7312)', 'auto').distance_km > 0;
----
true

# Test: Duration is positive
query I
SELECT travel_time_route_wkb('POINT(7.4281 43.7396)', 'POINT(7.4197 43.7312)', 'auto').duration_minutes > 0;
----
true

# Test: GEOMETRY input with ST_Point
query I
SELECT travel_time_route_wkb(ST_Point(7.4281, 43.7396), ST_Point(7.4197, 43.7312), 'auto').distance_km > 0;
----
true

# Test: WKB BLOB input
query I
SELECT travel_time_route_wkb(
    ST_AsWKB(ST_Point(7.4281, 43.7396)),
    ST_AsWKB(ST_Point(7.4197, 43.7312)),
    'auto'
).distance_km > 0;
----
true

# Test: Geometry field is BLOB type
query I
SELECT typeof(travel_time_route_wkb('POINT(7.4281 43.7396)', 'POINT(7.4197 43.7312)', 'auto').geometry);
----
BLOB

# Test: Geometry can be converted to GEOMETRY type
query I
SELECT ST_GeomType(ST_GeomFromWKB(
    travel_time_route_wkb('POINT(7.4281 43.7396)', 'POINT(7.4197 43.7312)', 'auto').geometry
));
----
LINESTRING

# Test: Route has multiple waypoints
query I
SELECT ST_NPoints(ST_GeomFromWKB(
    travel_time_route_wkb('POINT(7.4281 43.7396)', 'POINT(7.4197 43.7312)', 'auto').geometry
)) > 10;
----
true

# Test: Different costing modes
query I
SELECT travel_time_route_wkb('POINT(7.4281 43.7396)', 'POINT(7.4197 43.7312)', 'bicycle').distance_km > 0;
----
true

query I
SELECT travel_time_route_wkb('POINT(7.4281 43.7396)', 'POINT(7.4197 43.7312)', 'pedestrian').distance_km > 0;
----
true

# Test: Bicycle is slower than auto
query I
SELECT
    travel_time_route_wkb('POINT(7.4281 43.7396)', 'POINT(7.4197 43.7312)', 'bicycle').duration_minutes >
    travel_time_route_wkb('POINT(7.4281 43.7396)', 'POINT(7.4197 43.7312)', 'auto').duration_minutes;
----
true

# Test: travel_time function
query I
SELECT travel_time(43.7396, 7.4281, 43.7312, 7.4197, 'auto') > 0;
----
true

# Test: travel_time_locate snaps to road network
query I
SELECT travel_time_locate(43.7396, 7.4281, 'auto').lat BETWEEN 43.73 AND 43.75;
----
true

query I
SELECT travel_time_locate(43.7396, 7.4281, 'auto').lon BETWEEN 7.42 AND 7.44;
----
true

# Test: travel_time_matrix
query III
SELECT
    from_idx,
    to_idx,
    distance_m > 0
FROM travel_time_matrix(
    [43.7396, 43.7312],
    [7.4281, 7.4197],
    [43.7396, 43.7312],
    [7.4281, 7.4197],
    'auto'
)
WHERE from_idx != to_idx
ORDER BY from_idx, to_idx;
----
0	1	true
1	0	true

# Test: NULL handling - invalid coordinates should return NULL
query I
SELECT travel_time_route_wkb('POINT(0 0)', 'POINT(0 0)', 'auto') IS NULL;
----
true

# Test: travel_time_route macro (requires geometry_macro.sql)
statement ok
CREATE OR REPLACE MACRO travel_time_route(from_geom, to_geom, costing) AS (
    SELECT struct_pack(
        distance_km := r.distance_km,
        duration_minutes := r.duration_minutes,
        geometry := ST_GeomFromWKB(r.geometry)
    ) FROM (SELECT travel_time_route_wkb(from_geom, to_geom, costing) as r)
);

# Test: Macro returns GEOMETRY type
query I
SELECT typeof(travel_time_route(ST_Point(7.4281, 43.7396), ST_Point(7.4197, 43.7312), 'auto').geometry);
----
GEOMETRY

# Test: Macro geometry is a LINESTRING
query I
SELECT ST_GeomType(travel_time_route(ST_Point(7.4281, 43.7396), ST_Point(7.4197, 43.7312), 'auto').geometry);
----
LINESTRING

# Test: Macro has same distance as WKB version
query I
SELECT
    abs(travel_time_route(ST_Point(7.4281, 43.7396), ST_Point(7.4197, 43.7312), 'auto').distance_km -
        travel_time_route_wkb(ST_Point(7.4281, 43.7396), ST_Point(7.4197, 43.7312), 'auto').distance_km) < 0.01;
----
true
